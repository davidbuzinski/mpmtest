name: Build and Test
on: [push]

jobs:
  bat:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Perform npm tasks
        run: echo "hello"
  integ:
    needs: bat
    runs-on: windows-latest
    strategy:
      fail-fast: true
    steps:
      - name: Cache files for installer
        id: cache-matlab
        uses: actions/cache@v3
        with:
          path: 2023_06_06_09_11_28
          key: cache-matlab-win
      - name: Setup deps
        run: |
          curl -O --retry-connrefused https://ssd.mathworks.com/supportfiles/ci/matlab-batch/v0/install.sh
          ./install.sh
          # wget -qO- --retry-connrefused https://ssd.mathworks.com/supportfiles/ci/matlab-deps/v0/install.sh | sudo bash -s
      - name: Get files for installer
        if: steps.cache-matlab.outputs.cache-hit != 'true'
        shell: bash
        run: |
          curl -O https://mpmtest.s3.amazonaws.com/2023_06_06_09_11_28.zip
      - name: Unzip files
        if: steps.cache-matlab.outputs.cache-hit != 'true'
        run: |
          Expand-Archive 2023_06_06_09_11_28.zip -DestinationPath .
      - name: Setup mpm
        run: |
          curl https://mathworks.com/mpm/win64/mpm -L -o mpm.zip
          Expand-Archive mpm.zip -DestinationPath mpm
          ls mpm/bin
      - name: Install MATLAB
        shell: bash
        run: |
          ./mpm/bin/mpm.exe install --source "$(pwd)/2023_06_06_09_11_28" --destination "$(pwd)" --products MATLAB Parallel_Computing_Toolbox
          echo "$(pwd)/bin" >> $GITHUB_PATH
      - name: Run Sample MATLAB Command
        uses: matlab-actions/run-command@v1
        with:
          command: assert(~isempty(regexp(version('-release'), '\d{4}.')))
