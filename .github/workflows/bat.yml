name: Build and Test
on: [push]

jobs:
  bat:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Perform npm tasks
        run: echo "hello"
  integ:
    needs: bat
    runs-on: windows-latest
    strategy:
      fail-fast: true
    steps:
      - name: Cache files for installer
        id: cache-matlab
        uses: actions/cache@v3
        with:
          path: 2023_06_06_09_11_28
          key: cache-matlab-win
      - name: Setup deps
        shell: bash
        run: |
          wget -qO- --retry-connrefused https://ssd.mathworks.com/supportfiles/ci/matlab-batch/v0/install.sh | sudo bash -s
          # wget -qO- --retry-connrefused https://ssd.mathworks.com/supportfiles/ci/matlab-deps/v0/install.sh | sudo bash -s
      - name: Get files for installer
        if: steps.cache-matlab.outputs.cache-hit != 'true'
        shell: bash
        run: |
          wget -q https://mpmtest.s3.amazonaws.com/2023_06_06_09_11_28.zip -o 2023_06_01_09_45_50.zip
          cat 2023_06_01_09_45_50.zip* > 2023_06_01_09_45_50.zip
          ls
      - name: Unzip files
        if: steps.cache-matlab.outputs.cache-hit != 'true'
        shell: bash
        run: unzip -q 2023_06_06_09_11_28.zip
      - name: Setup mpm
        shell: bash
        run: |
          curl https://mathworks.com/mpm/win64/mpm -L -v -o mpm.zip
          unzip mpm.zip
      - name: Install MATLAB
        shell: bash
        run: |
          ./mpm/bin/mpm install --source "$(pwd)/2023_06_06_09_11_28" --destination "$(pwd)" --products MATLAB Parallel_Computing_Toolbox
          echo "$(pwd)/bin" >> $GITHUB_PATH
      - name: Run Sample MATLAB Command
        uses: matlab-actions/run-command@v1
        with:
          command: assert(~isempty(regexp(version('-release'), '\d{4}.')))
